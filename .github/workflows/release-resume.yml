name: Release Resume

on:
  push:
    tags:
      - 'v*' 

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Build and Release Resume
        run: |
          nix develop --command bash -c '
            cp dhall/render/developercv.cls .

            build_resume() {
              local render_file="$1"
              local output_name="$2"

              dhall text --file "$render_file" > "${output_name}.tex"
              pdflatex -interaction=nonstopmode -halt-on-error "${output_name}.tex"
              pdflatex -interaction=nonstopmode -halt-on-error "${output_name}.tex"
            }

            build_resume dhall/render/resume.dhall resume
            build_resume dhall/render/resume.sre.dhall resume-sre
            build_resume dhall/render/resume.platform-engineer.dhall resume-platform-engineer
            build_resume dhall/render/resume.cloud-devops.dhall resume-cloud-devops
          '
          # Create the release using the tag name
          gh release create "${GITHUB_REF#refs/tags/}" \
            --generate-notes \
            resume.pdf \
            resume-sre.pdf \
            resume-platform-engineer.pdf \
            resume-cloud-devops.pdf
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
